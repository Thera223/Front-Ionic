<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Paiement</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Sélection de la Commande -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Sélectionnez une Commande</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <form [formGroup]="paiementForm">
        <ion-item>
          <ion-label position="floating">Commande</ion-label>
          <ion-select
            formControlName="commandeId"
            interface="popover"
            placeholder="Choisissez une commande"
            (ionChange)="onCommandeChange()"
          >
            <ion-select-option
              *ngFor="let commande of commandes"
              [value]="commande.id"
            >
              <div class="commande-option">
                <span>
                  Commande #{{ commande.id }} - {{ commande.date | date:'medium' }}
                </span>
                <ion-badge
                  *ngIf="commande.isNew"
                  color="success"
                  class="new-badge"
                  >NOUVEAU</ion-badge
                >
              </div>
            </ion-select-option>
          </ion-select>
        </ion-item>
      </form>

      <!-- Détails de la Commande Sélectionnée -->
      <ng-container *ngIf="selectedCommande">
        <ion-list>
          <ion-list-header>
            <ion-label>Détails de la Commande</ion-label>
          </ion-list-header>

          <!-- Liste des Produits -->
          <ion-item *ngFor="let produit of selectedCommande.produits">
            <ion-label>
              <h2>{{ produit.nom }}</h2>
              <p>Quantité: {{ produit.quantite }}</p>
            </ion-label>
            <ion-text slot="end">
              {{ (produit.prix * produit.quantite) | currency:'XOF' }}
            </ion-text>
          </ion-item>

          <!-- Informations de Paiement -->
          <ng-container *ngIf="getInformationsPaiement() as infos">
          <ion-item>
  <ion-label>Total Commande</ion-label>
  <ion-text slot="end">
    <strong>{{ infos.totalCommande | currency:'XOF' }}</strong>
  </ion-text>
</ion-item>
<ion-item>
  <ion-label>Coût de Livraison</ion-label>
  <ion-text slot="end">
    <strong>{{ infos.coutLivraison | currency:'XOF' }}</strong>
  </ion-text>
</ion-item>
<ion-item>
  <ion-label>Total à Payer</ion-label>
  <ion-text slot="end" color="primary">
    <strong>{{ infos.totalAPayer | currency:'XOF' }}</strong>
  </ion-text>
</ion-item>

          </ng-container>
        </ion-list>
      </ng-container>
    </ion-card-content>
  </ion-card>

  <!-- Sélection du Mode de Paiement -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Choisissez un Mode de Paiement</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-grid>
        <ion-row>
          <ion-col
            size="4"
            *ngFor="let mode of modesPaiement"
            (click)="paiementForm.controls['modePaiement'].setValue(mode.id)"
          >
            <div
              class="payment-option"
              [class.selected]="paiementForm.value.modePaiement === mode.id"
            >
              <img [src]="getPaymentImage(mode.id)" [alt]="mode.name" />
              <ion-label>{{ mode.name }}</ion-label>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-content>
  </ion-card>

  <!-- Boutons d'Action -->
  <div class="action-buttons">
    <ion-button
      expand="block"
      color="medium"
      (click)="afficherRecapitulatif()"
      [disabled]="!paiementForm.valid"
    >
      Voir le Récapitulatif
    </ion-button>
    <ion-button
      expand="block"
      color="primary"
      (click)="confirmerPaiement()"
      [disabled]="!paiementForm.valid || !isSummaryVisible || isPaymentProcessing"
    >
      <ion-spinner
        slot="start"
        *ngIf="isPaymentProcessing"
        name="crescent"
      ></ion-spinner>
      Confirmer et Payer
    </ion-button>
  </div>

  <!-- Récapitulatif du Paiement -->
  <ion-card *ngIf="isSummaryVisible">
    <ion-card-header>
      <ion-card-title>Récapitulatif du Paiement</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-list>
        <ion-item>
          <ion-label>Commande</ion-label>
          <ion-text
            >#{{ selectedCommande?.id }} - {{ selectedCommande?.date | date:'medium' }}</ion-text
          >
        </ion-item>
        <ion-item>
          <ion-label>Mode de Paiement</ion-label>
          <ion-text>{{ getSelectedModeName() }}</ion-text>
        </ion-item>
        <ng-container *ngIf="getInformationsPaiement() as infos">
          <ion-item>
            <ion-label>Total à Payer</ion-label>
            <ion-text color="primary">
              <strong>{{ infos.totalAPayer | currency:'XOF' }}</strong>
            </ion-text>
          </ion-item>
        </ng-container>
      </ion-list>
    </ion-card-content>
  </ion-card>
</ion-content>
